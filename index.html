<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cashback-Rechner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #E9EAEC;
            color: #0f172a;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container { max-width: 680px; width: 100%; }
        .card {
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(15,23,42,0.08);
            padding: 26px;
            margin-bottom: 18px;
        }
        .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
        h1 { color:#0f172a; font-size:26px; display:flex; align-items:center; gap:10px; }
        .form-group { margin-bottom:16px; }
        label { display:block; margin-bottom:8px; color:#334155; font-weight:600; font-size:14px; }
        .input-row { display:flex; gap:10px; align-items:flex-end; }
        input[type="number"], input[type="text"], select {
            width:100%; padding:10px 12px; border:1px solid #d0d5db; border-radius:8px; font-size:15px;
            background:#fbfdfe; color:#0f172a; transition:border-color .18s, box-shadow .18s;
        }
        input:focus, select:focus { outline:none; border-color:#2b6cb0; box-shadow:0 0 0 4px rgba(43,108,176,0.08); }
        select.small { width:130px; flex-shrink:0; }
        .toggle-group { display:flex; align-items:center; gap:12px; margin:18px 0; padding:12px; background:#f7f8f9; border-radius:8px; }
        .toggle-switch { position:relative; width:50px; height:26px; background:#cfd6db; border-radius:13px; cursor:pointer; transition:background .22s; flex-shrink:0; }
        .toggle-switch.active { background:#FF3400; }
        .toggle-switch::after { content:""; position:absolute; width:22px; height:22px; border-radius:50%; background:white; top:2px; left:2px; transition:transform .22s; box-shadow:0 1px 3px rgba(2,6,23,.12); }
        .toggle-switch.active::after { transform:translateX(24px); }
        .exchange-rate-section { display:none; margin-top:16px; padding:14px; background:#fbfdff; border-radius:8px; border-left:4px solid #FF3400; }
        .exchange-rate-section.visible { display:block; }
        .exchange-rate-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
        .exchange-rate-row input { flex:1; font-weight:700; background:#fff; }
        .refresh-btn {
            background:#FF3400; color:#ffffff; border:1px solid rgba(0,0,0,.06); border-radius:8px;
            width:44px; height:40px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center;
            transition:background .12s, transform .12s, box-shadow .12s;
        }
        .refresh-btn:hover { background:#e12e00; transform:translateY(-1px); box-shadow:0 6px 18px rgba(255,52,0,.12); }
        .refresh-btn:active { transform:translateY(0); }
        .refresh-btn:focus { outline:3px solid rgba(255,52,0,.18); }
        .rate-timestamp { font-size:12px; color:#475569; margin-top:6px; }
        .loading-indicator { display:none; color:#FF3400; font-size:14px; margin-top:6px; }
        .loading-indicator.visible { display:block; }
        .error-message { display:none; background:#fff4f3; color:#7d2a1e; padding:10px; border-radius:6px; font-size:13px; margin-top:10px; border-left:4px solid #f87171; }
        .error-message.visible { display:block; }
        .results-card { background:#ffffff; color:#0f172a; border:1px solid #e6eaed; box-shadow:0 6px 18px rgba(15,23,42,.06); }
        .results-card h2 { color:#0f172a; margin-bottom:12px; font-size:20px; display:flex; align-items:center; gap:10px; }
        .result-item { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(15,23,42,.06); }
        .result-item:last-child { border-bottom:none; }
        .result-label { font-size:14px; color:#334155; }
        .result-value { font-size:18px; font-weight:700; color:#0f172a; }
        .result-value.highlight { font-size:20px; color:#FF3400; }
        .currency-symbol { margin-left:6px; color:#475569; }
        .info-wrapper { margin:18px 0; display:grid; gap:12px; }
        .info-box { background:#ffffff; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(15,23,42,.05); font-size:14px; color:#0f172a; line-height:1.45; border:1px solid #e6eaed; }
        .info-box h3 { margin-bottom:8px; font-size:15px; color:#0f172a; }
        .info-box ul { margin-left:18px; margin-top:6px; color:#334155; }
        .info-box .example { margin-top:10px; padding:10px; background:#fff6f1; border-left:4px solid #FF3400; border-radius:8px; font-weight:600; white-space:pre-line; color:#0f172a; }
        .info-box.secondary { background:#fffefa; }
        @media (max-width:600px) {
            .card { padding:18px; } h1 { font-size:20px; } .input-row { flex-direction:column; align-items:stretch; } select.small { width:100%; } .refresh-btn { width:42px; height:36px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="top-row">
                <h1 id="appHeader">Cashback-Rechner</h1>
                <div style="display:flex; gap:8px; align-items:center;">
                    <label for="langSelect" style="font-weight:600; color:#334155; font-size:14px; margin-right:6px;">DE</label>
                    <select id="langSelect" class="small" aria-label="Language">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="es">Español</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label id="labelPurchase" for="purchaseAmount">Kaufbetrag (inkl. MwSt.):</label>
                <div class="input-row">
                    <input type="number" id="purchaseAmount" min="0" step="0.01" placeholder="100.00" value="100" />
                    <select id="currency" class="small" aria-label="Currency">
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="SEK">SEK</option>
                        <option value="PLN">PLN</option>
                        <option value="MXN">MXN</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label id="labelVat" for="vatRate">Mehrwertsteuersatz (%):</label>
                <input type="number" id="vatRate" min="0" max="100" step="0.1" placeholder="19" value="19" />
            </div>

            <div class="form-group">
                <label id="labelCashbackRate" for="cashbackRate">Cashback-Rate (%):</label>
                <input type="number" id="cashbackRate" min="0" max="100" step="0.1" placeholder="2.5" value="2.5" />
            </div>

            <div class="toggle-group">
                <div class="toggle-switch" id="usdToggle" role="button" aria-pressed="false" tabindex="0"></div>
                <label id="usdToggleLabel" style="margin:0; cursor:pointer;">USD-Konversion aktivieren</label>
            </div>

            <div class="exchange-rate-section" id="exchangeRateSection" aria-hidden="true">
                <label id="labelExchange">USD-Wechselkurs:</label>
                <div class="exchange-rate-row">
                    <input type="number" id="exchangeRate" step="0.0001" placeholder="Lade..." />
                    <button class="refresh-btn" id="refreshBtn" aria-label="Refresh rates">↻</button>
                </div>
                <div class="rate-timestamp" id="rateTimestamp"></div>
                <div class="loading-indicator" id="loadingIndicator">Lade Kurse...</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>

        <div class="card results-card">
            <h2 id="resultsHeader">Ergebnis</h2>

            <div class="result-item">
                <span class="result-label" id="labelNet">Preis exkl. MwSt.:</span>
                <span class="result-value" id="resultNetPrice">0.00</span>
            </div>

            <div class="result-item">
                <span class="result-label" id="labelCashback">Cashback:</span>
                <span class="result-value highlight" id="resultCashback">0.00</span>
            </div>

            <div class="result-item">
                <span class="result-label" id="labelEffective">Effektivpreis:</span>
                <span class="result-value highlight" id="resultEffectivePrice">0.00</span>
            </div>

            <div class="result-item">
                <span class="result-label" id="labelSavings">Ersparnis:</span>
                <span class="result-value" id="resultSavings">0.0%</span>
            </div>
        </div>

        <!-- Infoboxen: Erläuterungen (unter den Ergebnissen) -->
        <div class="info-wrapper" aria-label="Erläuterungen">
            <div class="info-box" role="note">
                <h3 id="howHeader">Wie funktioniert Cashback?</h3>
                <p id="howText">Cashback ist eine Rückvergütung, die du für Online-Einkäufe erhältst und die dir aufs Bankkonto ausgezahlt wird.</p>
                <p>&nbsp;</p>
                <p><strong id="importantHeader">Wichtig zu wissen:</strong></p>
                <ul id="importantList">
                    <li>Cashback wird immer auf den Netto-Preis berechnet (Kaufpreis ohne Mehrwertsteuer)</li>
                    <li>Die Cashback-Rate variiert je nach Shop (meist 1–10%)</li>
                </ul>
                <div class="example" id="howExample">Beispiel:

Kaufpreis: 100€ (inkl. 19% MwSt.)
Netto-Preis: 84.03€
Cashback (3%): 2.52€

→ Du zahlst effektiv nur 97.48€</div>
            </div>

            <div class="info-box secondary" role="note">
                <h3 id="usdHeader">Was bedeutet USD-Konversion?</h3>
                <p id="usdText">Einige internationale Partnershops (z.B. AliExpress) erfassen den Kaufpreis im Hintergrund in USD, bevor sie das Cashback berechnen.</p>
                <p>&nbsp;</p>
                <p><strong id="whenHeader">Wann aktivieren?</strong></p>
                <ul id="whenList">
                    <li>✅ Wenn in den Cashback‑Bedingungen eine USD‑Umrechnung erwähnt wird</li>
                    <li>❌ Nicht nötig bei normalen europäischen Shops, dort bleibt die Berechnung meist in Euro</li>
                </ul>
                <p>&nbsp;</p>
                <div class="example" id="usdExample">Beispiel mit 100 € Einkaufswert bei 19% MwSt. und 3% Cashback:

Ohne USD‑Konversion (Einkaufswert: 100 € inkl. MwSt):
- Netto = 84,03€
- Cashback = 84,03€ × 3% = 2,52€
- Effektivpreis = 100,00€ − 2,52€ = 97,48€

Mit USD‑Konversion bei gleichem Einkaufswert:
- Netto = 84,03€ → Netto in USD ≈ 108,47 USD
- Cashback = 108,47 USD × 3% = 3,25 USD → umgerechnet ≈ 3,00€
- Effektivpreis = 100,00€ − 3,00€ ≈ 97,00€

Hinweis: Werte sind gerundet, denn Umrechnungskurse schwanken ständig.</div>
            </div>
        </div>
    </div>

    <script>
        const LANG_MAP = {
            de: {
                langLabel: 'Deutsch',
                title: 'Cashback-Rechner',
                header: 'Cashback-Rechner',
                labelPurchase: 'Kaufbetrag (inkl. MwSt.):',
                labelVat: 'Mehrwertsteuersatz (%):',
                labelCashbackRate: 'Cashback-Rate (%):',
                usdToggle: 'USD-Konversion aktivieren',
                labelExchange: 'USD-Wechselkurs:',
                refreshAria: 'Kurse aktualisieren',
                loadingRates: 'Lade Kurse...',
                errorOffline: '⚠️ Offline-Kurs verwendet (kein Internet)',
                resultsHeader: 'Ergebnis',
                labelNet: 'Preis exkl. MwSt.:',
                labelCashback: 'Cashback:',
                labelEffective: 'Effektivpreis:',
                labelSavings: 'Ersparnis:',
                howHeader: 'Wie funktioniert Cashback?',
                howText: 'Cashback ist eine Rückvergütung, die du für Online-Einkäufe erhältst und die dir aufs Bankkonto ausgezahlt wird.',
                importantHeader: 'Wichtig zu wissen:',
                importantList: [
                    'Cashback wird immer auf den Netto-Preis berechnet (Kaufpreis ohne Mehrwertsteuer)',
                    'Die Cashback-Rate variiert je nach Shop (meist 1–10%)'
                ],
                howExample: 'Beispiel:\n\nKaufpreis: 100€ (inkl. 19% MwSt.)\nNetto-Preis: 84.03€\nCashback (3%): 2.52€\n\n→ Du zahlst effektiv nur 97.48€',
                usdHeader: 'Was bedeutet USD-Konversion?',
                usdText: 'Einige internationale Partnershops (z.B. AliExpress) erfassen den Kaufpreis im Hintergrund in USD, bevor sie das Cashback berechnen.',
                whenHeader: 'Wann aktivieren?',
                whenList: [
                    '✅ Wenn in den Cashback‑Bedingungen eine USD‑Umrechnung erwähnt wird',
                    '❌ Nicht nötig bei normalen europäischen Shops, dort bleibt die Berechnung meist in Euro'
                ],
                usdExample: 'Beispiel mit 100 € Einkaufswert bei 19% MwSt. und 3% Cashback:\n\nOhne USD‑Konversion (Einkaufswert: 100 € inkl. MwSt):\n- Netto = 84,03€\n- Cashback = 84,03€ × 3% = 2,52€\n- Effektivpreis = 100,00€ − 2,52€ = 97,48€\n\nMit USD‑Konversion bei gleichem Einkaufswert:\n- Netto = 84,03€ → Netto in USD ≈ 108,47 USD\n- Cashback = 108,47 USD × 3% = 3,25 USD → umgerechnet ≈ 3,00€\n- Effektivpreis = 100,00€ − 3,00€ ≈ 97,00€\n\nHinweis: Werte sind gerundet, denn Umrechnungskurse schwanken ständig.'
            },

            // English — more natural native phrasing
            en: {
                langLabel: 'English',
                title: 'Cashback Calculator',
                header: 'Cashback Calculator',
                labelPurchase: 'Purchase amount (incl. VAT):',
                labelVat: 'VAT rate (%):',
                labelCashbackRate: 'Cashback rate (%):',
                usdToggle: 'Enable USD conversion',
                labelExchange: 'USD exchange rate:',
                refreshAria: 'Refresh rates',
                loadingRates: 'Loading rates...',
                errorOffline: '⚠️ Using fallback rates (offline)',
                resultsHeader: 'RESULTS',
                labelNet: 'Price excl. VAT:',
                labelCashback: 'Cashback:',
                labelEffective: 'Effective price:',
                labelSavings: 'Savings:',
                howHeader: 'How cashback works',
                howText: 'Cashback is a partial refund you receive on online purchases; the amount is returned to your bank account.',
                importantHeader: 'Important to know:',
                importantList: [
                    'Cashback is always calculated on the net price (price before VAT)',
                    'Cashback rates vary by shop (typically 1–10%)'
                ],
                howExample: 'Example:\n\nPurchase: €100 (incl. 19% VAT)\nNet price: €84.03\nCashback (3%): €2.52\n\n→ You effectively pay €97.48',
                usdHeader: 'What is USD conversion?',
                usdText: 'Some international partner shops (e.g. AliExpress) first convert the net amount to US dollars, calculate cashback in USD, and then convert the cashback back to euros. Differences in exchange rates and rounding can lead to a different cashback amount than when calculating directly in euros.',
                whenHeader: 'When should I enable it?',
                whenList: [
                    '✅ Enable this if the cashback terms explicitly mention USD conversion',
                    '❌ Not usually needed for standard European shops; they normally calculate in EUR'
                ],
                usdExample: 'Example with a €100 purchase, 19% VAT and 3% cashback:\n\nWithout USD conversion (paid by customer: €100):\n- Net = €84.03\n- Cashback = €84.03 × 3% = €2.52\n- Effective price = €100.00 − €2.52 = €97.48\n\nWith USD conversion (paid by customer: €100):\n- Net = €84.03 → Net in USD ≈ $108.47\n- Cashback = $108.47 × 3% = $3.25 → converted ≈ €3.00\n- Effective price = €100.00 − €3.00 ≈ €97.00\n\nNote: Values are rounded; exact amounts depend on the exchange rate used.'
            },

            // Spanish — natural native phrasing
            es: {
                langLabel: 'Español',
                title: 'Calculadora de Cashback',
                header: 'Calculadora de Cashback',
                labelPurchase: 'Importe de compra (incl. IVA):',
                labelVat: 'Tipo de IVA (%):',
                labelCashbackRate: 'Tasa de cashback (%):',
                usdToggle: 'Activar conversión a USD',
                labelExchange: 'Tipo de cambio USD:',
                refreshAria: 'Actualizar tipos',
                loadingRates: 'Cargando tipos...',
                errorOffline: '⚠️ Usando tipos de corte (sin conexión)',
                resultsHeader: 'RESULTADOS',
                labelNet: 'Precio sin IVA:',
                labelCashback: 'Cashback:',
                labelEffective: 'Precio efectivo:',
                labelSavings: 'Ahorro:',
                howHeader: 'Cómo funciona el cashback',
                howText: 'El cashback es un reembolso parcial por compras online que se abona en tu cuenta bancaria.',
                importantHeader: 'Importante saber:',
                importantList: [
                    'El cashback siempre se calcula sobre el precio neto (sin IVA)',
                    'La tasa de cashback varía según la tienda (normalmente 1–10%)'
                ],
                howExample: 'Ejemplo:\n\nCompra: 100 € (incl. 19% IVA)\nPrecio neto: 84,03 €\nCashback (3%): 2,52 €\n\n→ Pagas efectivamente 97,48 €',
                usdHeader: '¿Qué significa conversión a USD?',
                usdText: 'Algunas tiendas internacionales (p. ej. AliExpress) convierten primero el importe neto a dólares estadounidenses, calculan el cashback en USD y luego lo convierten de nuevo a euros. Las diferencias en el tipo de cambio y los redondeos pueden provocar que el cashback resulte distinto al calculado directamente en euros.',
                whenHeader: '¿Cuándo activarlo?',
                whenList: [
                    '✅ Actívalo si las condiciones de cashback mencionan explícitamente la conversión a USD',
                    '❌ Normalmente no es necesario para tiendas europeas; suelen calcular en EUR'
                ],
                usdExample: 'Ejemplo con una compra de 100 €, 19% IVA y 3% cashback:\n\nSin conversión a USD (pagado por el cliente: 100 €):\n- Neto = 84,03 €\n- Cashback = 84,03 € × 3% = 2,52 €\n- Precio efectivo = 100,00 € − 2,52 € = 97,48 €\n\nCon conversión a USD (pagado por el cliente: 100 €):\n- Neto = 84,03 € → Neto en USD ≈ $108,47\n- Cashback = $108,47 × 3% = $3,25 → convertido ≈ 3,00 €\n- Precio efectivo = 100,00 € − 3,00 € ≈ 97,00 €\n\nNota: Los valores están redondeados; dependen del tipo de cambio utilizado.'
            }
        };

        // DOM refs
        const langSelect = document.getElementById('langSelect');
        const appHeader = document.getElementById('appHeader');
        const labelPurchase = document.getElementById('labelPurchase');
        const labelVat = document.getElementById('labelVat');
        const labelCashbackRate = document.getElementById('labelCashbackRate');
        const usdToggleLabel = document.getElementById('usdToggleLabel');
        const labelExchange = document.getElementById('labelExchange');
        const refreshBtn = document.getElementById('refreshBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const resultsHeader = document.getElementById('resultsHeader');
        const labelNet = document.getElementById('labelNet');
        const labelCashback = document.getElementById('labelCashback');
        const labelEffective = document.getElementById('labelEffective');
        const labelSavings = document.getElementById('labelSavings');
        const howHeader = document.getElementById('howHeader');
        const howText = document.getElementById('howText');
        const importantHeader = document.getElementById('importantHeader');
        const importantList = document.getElementById('importantList');
        const howExample = document.getElementById('howExample');
        const usdHeader = document.getElementById('usdHeader');
        const usdText = document.getElementById('usdText');
        const whenHeader = document.getElementById('whenHeader');
        const whenList = document.getElementById('whenList');
        const usdExample = document.getElementById('usdExample');

        // other DOM
        const purchaseAmountInput = document.getElementById('purchaseAmount');
        const currencySelect = document.getElementById('currency');
        const vatRateInput = document.getElementById('vatRate');
        const cashbackRateInput = document.getElementById('cashbackRate');
        const usdToggle = document.getElementById('usdToggle');
        const exchangeRateSection = document.getElementById('exchangeRateSection');
        const exchangeRateInput = document.getElementById('exchangeRate');
        const rateTimestamp = document.getElementById('rateTimestamp');
        const refreshButton = document.getElementById('refreshBtn');
        const resultNetPrice = document.getElementById('resultNetPrice');
        const resultCashback = document.getElementById('resultCashback');
        const resultEffectivePrice = document.getElementById('resultEffectivePrice');
        const resultSavings = document.getElementById('resultSavings');

        // i18n apply
        function applyTranslations(lang) {
            const t = LANG_MAP[lang] || LANG_MAP.de;
            document.documentElement.lang = lang;
            document.title = t.title;
            appHeader.textContent = t.header;
            labelPurchase.textContent = t.labelPurchase;
            labelVat.textContent = t.labelVat;
            labelCashbackRate.textContent = t.labelCashbackRate;
            usdToggleLabel.textContent = t.usdToggle;
            labelExchange.textContent = t.labelExchange;
            refreshBtn.setAttribute('aria-label', t.refreshAria);
            loadingIndicator.textContent = t.loadingRates;
            errorMessage.textContent = '';
            resultsHeader.textContent = t.resultsHeader;
            labelNet.textContent = t.labelNet;
            labelCashback.textContent = t.labelCashback;
            labelEffective.textContent = t.labelEffective;
            labelSavings.textContent = t.labelSavings;
            howHeader.textContent = t.howHeader;
            howText.textContent = t.howText;
            importantHeader.textContent = t.importantHeader;

            // rebuild importantList
            importantList.innerHTML = '';
            t.importantList.forEach(item => {
                const li = document.createElement('li'); li.textContent = item; importantList.appendChild(li);
            });

            howExample.textContent = t.howExample;
            usdHeader.textContent = t.usdHeader;
            usdText.textContent = t.usdText;
            whenHeader.textContent = t.whenHeader;
            whenList.innerHTML = '';
            t.whenList.forEach(item => { const li = document.createElement('li'); li.textContent = item; whenList.appendChild(li); });
            usdExample.textContent = t.usdExample;
        }

        // initialize language
        langSelect.addEventListener('change', () => {
            applyTranslations(langSelect.value);
        });

        // keep previous logic (exchange rates, calculation) intact
        const CURRENCY_SYMBOLS = { EUR: '€', GBP: '£', SEK: 'kr', PLN: 'zł', MXN: '$' };
        const FALLBACK_RATES = { EUR: 1.10, GBP: 1.27, SEK: 0.096, PLN: 0.25, MXN: 0.059 };
        const CACHE_KEY = 'cashback_calculator_rates';
        const CACHE_DURATION = 60 * 60 * 1000;

        let exchangeRates = {};
        let usdConversionActive = false;

        document.addEventListener('DOMContentLoaded', async () => {
            applyTranslations(langSelect.value || 'de');
            calculateCashback();
            await fetchExchangeRates();
            setupEventListeners();
        });

        function setupEventListeners() {
            purchaseAmountInput.addEventListener('input', calculateCashback);
            vatRateInput.addEventListener('input', calculateCashback);
            cashbackRateInput.addEventListener('input', calculateCashback);
            currencySelect.addEventListener('change', async () => { await updateExchangeRateDisplay(); calculateCashback(); });

            const toggleUSDConversion = () => {
                usdConversionActive = !usdConversionActive;
                usdToggle.classList.toggle('active', usdConversionActive);
                exchangeRateSection.classList.toggle('visible', usdConversionActive);
                exchangeRateSection.setAttribute('aria-hidden', (!usdConversionActive).toString());
                usdToggle.setAttribute('aria-pressed', String(usdConversionActive));
                if (usdConversionActive) updateExchangeRateDisplay();
                calculateCashback();
            };

            usdToggle.addEventListener('click', toggleUSDConversion);
            usdToggle.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleUSDConversion(); } });
            const usdToggleLabelElm = document.getElementById('usdToggleLabel');
            if (usdToggleLabelElm) usdToggleLabelElm.addEventListener('click', toggleUSDConversion);

            refreshButton.addEventListener('click', async () => { await fetchExchangeRates(true); });

            exchangeRateInput.addEventListener('input', (e) => {
                const rate = parseFloat(e.target.value);
                if (!isNaN(rate) && rate > 0) {
                    const currency = currencySelect.value;
                    exchangeRates[currency] = rate;
                    calculateCashback();
                }
            });
        }

        function getCachedRates() {
            try { const cached = localStorage.getItem(CACHE_KEY); if (!cached) return null; return JSON.parse(cached); } catch { return null; }
        }
        function setCachedRates(rates) { try { localStorage.setItem(CACHE_KEY, JSON.stringify({ rates, timestamp: Date.now() })); } catch {}
        }
        function isCacheValid(cachedData) { if (!cachedData || !cachedData.timestamp) return false; return (Date.now() - cachedData.timestamp) < CACHE_DURATION; }

        async function fetchExchangeRates(forceRefresh = false) {
            const t = LANG_MAP[langSelect.value] || LANG_MAP.de;
            if (!forceRefresh) {
                const cached = getCachedRates();
                if (cached && isCacheValid(cached)) { exchangeRates = cached.rates; updateExchangeRateDisplay(); return; }
            }
            loadingIndicator.classList.add('visible'); errorMessage.classList.remove('visible'); rateTimestamp.textContent = '';
            const currencies = ['EUR','GBP','SEK','PLN','MXN']; const newRates = {}; let hasError = false;
            const promises = currencies.map(async (currency) => {
                try {
                    const response = await fetch(`https://api.frankfurter.app/latest?from=${currency}&to=USD`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json(); const rate = data.rates?.USD;
                    if (rate) newRates[currency] = rate; else throw new Error('No rate');
                } catch (err) { newRates[currency] = FALLBACK_RATES[currency]; hasError = true; }
            });
            await Promise.all(promises);
            exchangeRates = newRates; setCachedRates(newRates);
            loadingIndicator.classList.remove('visible');
            if (hasError) { errorMessage.textContent = t.errorOffline; errorMessage.classList.add('visible'); }
            updateExchangeRateDisplay();
            if (usdConversionActive) calculateCashback();
        }

        function updateExchangeRateDisplay() {
            const currency = currencySelect.value;
            const rate = exchangeRates[currency] !== undefined ? exchangeRates[currency] : FALLBACK_RATES[currency];
            if (rate !== undefined) {
                exchangeRateInput.value = rate.toFixed(4);
                const cached = getCachedRates();
                if (cached && cached.timestamp) {
                    const date = new Date(cached.timestamp);
                    const formattedDate = date.toLocaleDateString(langSelect.value || 'de-DE', { day:'2-digit', month:'2-digit', year:'numeric' });
                    const formattedTime = date.toLocaleTimeString(langSelect.value || 'de-DE', { hour:'2-digit', minute:'2-digit' });
                    rateTimestamp.textContent = `${ (LANG_MAP[langSelect.value]||LANG_MAP.de).labelExchange } ${formattedDate}, ${formattedTime}`;
                } else {
                    rateTimestamp.textContent = '';
                }
            } else { exchangeRateInput.value = ''; rateTimestamp.textContent = ''; }
        }

        function showError(message) { errorMessage.textContent = message; errorMessage.classList.add('visible'); }
        function hideError() { errorMessage.classList.remove('visible'); }

        function calculateCashback() {
            const purchaseAmount = parseFloat(purchaseAmountInput.value) || 0;
            const vatRate = parseFloat(vatRateInput.value) || 0;
            const cashbackRate = parseFloat(cashbackRateInput.value) || 0;
            const currency = currencySelect.value;
            if (purchaseAmount <= 0 || vatRate < 0 || cashbackRate < 0) { updateResults(0,0,0,0,currency); return; }
            let netPrice, cashbackAmount, effectivePrice;
            if (usdConversionActive) {
                const exchangeRate = exchangeRates[currency] !== undefined ? exchangeRates[currency] : FALLBACK_RATES[currency];
                if (exchangeRate !== undefined) {
                    netPrice = purchaseAmount / (1 + vatRate/100);
                    const netPriceUSD = netPrice * exchangeRate;
                    const cashbackUSD = netPriceUSD * (cashbackRate/100);
                    const effectiveNetPriceUSD = netPriceUSD - cashbackUSD;
                    const conversionRate = parseFloat(exchangeRateInput.value) || exchangeRate;
                    const effectiveNetPrice = effectiveNetPriceUSD / conversionRate;
                    effectivePrice = effectiveNetPrice * (1 + vatRate/100);
                    cashbackAmount = cashbackUSD / conversionRate;
                } else {
                    netPrice = purchaseAmount / (1 + vatRate/100);
                    cashbackAmount = netPrice * (cashbackRate/100);
                    effectivePrice = purchaseAmount - cashbackAmount;
                }
            } else {
                netPrice = purchaseAmount / (1 + vatRate/100);
                cashbackAmount = netPrice * (cashbackRate/100);
                effectivePrice = purchaseAmount - cashbackAmount;
            }
            cashbackAmount = purchaseAmount - effectivePrice;
            const savingsPercent = purchaseAmount > 0 ? (cashbackAmount / purchaseAmount) * 100 : 0;
            updateResults(netPrice, cashbackAmount, effectivePrice, savingsPercent, currency);
        }

        function updateResults(netPrice, cashback, effectivePrice, savings, currency) {
            resultNetPrice.textContent = formatCurrency(netPrice, currency);
            resultCashback.textContent = formatCurrency(cashback, currency);
            resultEffectivePrice.textContent = formatCurrency(effectivePrice, currency);
            resultSavings.textContent = (isNaN(savings) ? 0 : savings).toFixed(1) + '%';
        }

        function formatCurrency(amount, currency) {
            const symbol = CURRENCY_SYMBOLS[currency] || '';
            const formatted = (isNaN(amount) ? 0 : amount).toFixed(2);
            return `${formatted} ${symbol}`;
        }
    </script>
</body>
</html>
